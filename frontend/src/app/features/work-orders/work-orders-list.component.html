<div class="work-orders-container">
  <div class="page-header">
    <div class="header-content">
      <h1>Ordenes de Trabajo</h1>
      <p>Gestione las ordenes de trabajo de la optica</p>
    </div>
    <button class="btn-primary" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Nueva Orden
    </button>
  </div>

  @if (successMessage) {
    <button type="button" class="alert alert-success" (click)="clearMessages()">
      {{ successMessage }}
    </button>
  }

  @if (errorMessage && !showModal) {
    <button type="button" class="alert alert-error" (click)="clearMessages()">
      {{ errorMessage }}
    </button>
  }

  <div class="filters-bar">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input 
        type="text" 
        placeholder="Buscar por nombre, RUT o numero de orden..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
      />
    </div>
    <select [(ngModel)]="filterType" (ngModelChange)="applyFilters()">
      <option value="">Todos los tipos</option>
      @for (type of workOrderTypes; track type.value) {
        <option [value]="type.value">{{ type.label }}</option>
      }
    </select>
    <select [(ngModel)]="filterOrderNumberType" (ngModelChange)="applyFilters()">
      <option value="">Todas las empresas</option>
      @for (type of orderNumberTypes; track type.value) {
        <option [value]="type.value">{{ type.label }}</option>
      }
    </select>
  </div>

  <div class="work-orders-table-container">
    @if (isLoading && workOrders.length === 0) {
      <div class="loading-state">
        <div class="spinner-large"></div>
        <p>Cargando ordenes...</p>
      </div>
    } @else if (filteredWorkOrders.length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
          <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
        </svg>
        <h3>No hay ordenes de trabajo</h3>
        <p>{{ searchTerm || filterType || filterOrderNumberType ? 'No se encontraron resultados' : 'Comience creando una nueva orden' }}</p>
      </div>
    } @else {
      <div class="cards-container">
        @for (order of filteredWorkOrders; track order._id) {
          <div class="order-card">
            <div class="card-header">
              <div class="order-info">
                <span class="order-number">{{ getDisplayOrderNumber(order) }}</span>
                <span class="type-badge" [attr.data-type]="order.tipoOrden">
                  {{ getTypeLabel(order.tipoOrden) }}
                </span>
                <span class="company-badge" [attr.data-company]="order.tipoNumeroOrden">
                  {{ getOrderNumberTypeLabel(order.tipoNumeroOrden) }}
                </span>
              </div>
              <span class="order-date">{{ formatDate(order.createdAt) }}</span>
            </div>
            <div class="card-body">
              <div class="client-info">
                <span class="client-name">{{ getClientName(order) }}</span>
                <span class="client-rut">{{ getClientRut(order) }}</span>
              </div>
              <div class="payment-info">
                <div class="payment-row">
                  <span class="label">Total:</span>
                  <span class="value">{{ formatCurrency(order.compra.totalVenta) }}</span>
                </div>
                <div class="payment-row">
                  <span class="label">Saldo:</span>
                  <span class="value" [class.saldo-pendiente]="(order.compra.saldo || 0) > 0">
                    {{ formatCurrency(order.compra.saldo) }}
                  </span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn-icon" title="Ver detalle" (click)="openDetailModal(order)">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
              @if (isAdmin) {
                <button class="btn-icon" title="Editar" (click)="openEditModal(order)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                  </svg>
                </button>
                <button class="btn-icon btn-danger" title="Eliminar" (click)="confirmDelete(order)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  </svg>
                </button>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

@if (showModal) {
  <div class="modal-overlay" role="dialog" aria-modal="true" (click)="closeModal()" (keydown.escape)="closeModal()">
    <div class="modal modal-large" role="document" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditing ? 'Editar Orden de Trabajo' : 'Nueva Orden de Trabajo' }}</h2>
        <button class="btn-close" (click)="closeModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        @if (errorMessage) {
          <div class="alert alert-error">{{ errorMessage }}</div>
        }

                <div class="form-section">
                  <h3>Informacion General</h3>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="tipoNumeroOrden">Empresa *</label>
                      <select id="tipoNumeroOrden" [(ngModel)]="formData.tipoNumeroOrden">
                        @for (type of orderNumberTypes; track type.value) {
                          <option [value]="type.value">{{ type.label }}</option>
                        }
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="tipoOrden">Tipo *</label>
                      <select id="tipoOrden" [(ngModel)]="formData.tipoOrden">
                        @for (type of workOrderTypes; track type.value) {
                          <option [value]="type.value">{{ type.label }}</option>
                        }
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="numeroOrdenManual">N Orden Manual</label>
                      <input type="text" id="numeroOrdenManual" [(ngModel)]="formData.numeroOrdenManual" placeholder="#12345" />
                      <small class="form-hint">Opcional. Prefijo # para ordenes manuales</small>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label for="fechaVenta">Fecha de Venta *</label>
                      <input type="date" id="fechaVenta" [(ngModel)]="formData.fechaVenta" />
                    </div>
                  </div>
                </div>

                <div class="form-section">
                  <h3>Cliente</h3>
                  <div class="client-selection">
                    @if (!isNewClient && !selectedClient) {
                      <div class="form-group client-search-group">
                        <label for="clientSearch">Buscar Cliente Existente</label>
                        <div class="search-input-wrapper">
                          <input 
                            type="text" 
                            id="clientSearch" 
                            [(ngModel)]="clientSearchTerm" 
                            (input)="searchClients()"
                            (focus)="showClientDropdown = true"
                            placeholder="Buscar por nombre, RUT o telefono..." 
                            autocomplete="off"
                          />
                          @if (showClientDropdown && filteredClients.length > 0) {
                            <div class="client-dropdown">
                              @for (client of filteredClients; track client._id) {
                                <button type="button" class="client-option" (click)="selectClient(client)">
                                  <span class="client-name">{{ client.nombre }}</span>
                                  <span class="client-rut">{{ client.rut }}</span>
                                </button>
                              }
                            </div>
                          }
                        </div>
                      </div>
                      <div class="client-actions">
                        <button type="button" class="btn-outline" (click)="toggleNewClient()">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                          Nuevo Cliente
                        </button>
                      </div>
                    }
                    @if (selectedClient) {
                      <div class="selected-client-card">
                        <div class="client-info-display">
                          <span class="client-name">{{ selectedClient.nombre }}</span>
                          <span class="client-rut">{{ selectedClient.rut }}</span>
                          @if (selectedClient.telefono) {
                            <span class="client-phone">{{ selectedClient.telefono }}</span>
                          }
                        </div>
                        <button type="button" class="btn-icon btn-small" (click)="clearClientSelection()" title="Cambiar cliente">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                          </svg>
                        </button>
                      </div>
                    }
                    @if (isNewClient) {
                      <div class="new-client-form">
                        <div class="form-row">
                          <div class="form-group">
                            <label for="clienteNombre">Nombre *</label>
                            <input type="text" id="clienteNombre" [(ngModel)]="clienteFormData.nombre" placeholder="Nombre completo" />
                          </div>
                          <div class="form-group">
                            <label for="clienteRut">RUT *</label>
                            <input type="text" id="clienteRut" [(ngModel)]="clienteFormData.rut" placeholder="12.345.678-9" (blur)="onClientRutChange()" />
                          </div>
                        </div>
                        <div class="form-row">
                          <div class="form-group">
                            <label for="clienteTelefono">Telefono</label>
                            <input type="text" id="clienteTelefono" [(ngModel)]="clienteFormData.telefono" placeholder="+56 9 1234 5678" />
                          </div>
                          <div class="form-group">
                            <label for="clienteEmail">Email</label>
                            <input type="email" id="clienteEmail" [(ngModel)]="clienteFormData.email" placeholder="cliente@ejemplo.com" />
                          </div>
                        </div>
                        <div class="form-row client-form-actions">
                          <button type="button" class="btn-primary btn-save-client" (click)="saveNewClient()" [disabled]="savingClient">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                              <polyline points="17 21 17 13 7 13 7 21"></polyline>
                              <polyline points="7 3 7 8 15 8"></polyline>
                            </svg>
                            {{ savingClient ? 'Guardando...' : 'Ingresar Cliente' }}
                          </button>
                          <button type="button" class="btn-outline" (click)="toggleNewClient()">Cancelar</button>
                        </div>
                        @if (clientSaveMessage) {
                          <div class="alert alert-success client-save-alert">{{ clientSaveMessage }}</div>
                        }
                        @if (clientSaveError) {
                          <div class="alert alert-error client-save-alert">{{ clientSaveError }}</div>
                        }
                      </div>
                    }
                  </div>
                </div>

                @if (requiresReceta()) {
                  <div class="prescription-buttons-section">
                    <button type="button" class="btn-prescription btn-prescription-lejos" (click)="openPrescriptionFormModal('lejos')" title="Ingresar receta lejos">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="10.5" cy="7.5" r="2.5"></circle>
                        <circle cx="22" cy="7.5" r="2.5"></circle>
                        <path d="M2 7.5h6"></path>
                        <path d="M13 7.5h6"></path>
                        <path d="M5 10v4a2 2 0 0 0 2 2h2"></path>
                        <path d="M19 10v4a2 2 0 0 1-2 2h-2"></path>
                      </svg>
                      {{ selectedPrescriptionLejos ? 'Receta Lejos Ingresada' : 'Ingresar Receta Lejos' }}
                    </button>
                    <button type="button" class="btn-prescription btn-prescription-cerca" (click)="openPrescriptionFormModal('cerca')" title="Ingresar receta cerca">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M6 19l-2 2"></path>
                        <path d="M18 19l2 2"></path>
                        <rect x="6" y="16" width="12" height="6" rx="1"></rect>
                      </svg>
                      {{ selectedPrescriptionCerca ? 'Receta Cerca Ingresada' : 'Ingresar Receta Cerca' }}
                    </button>
                  </div>
        }

        <div class="form-section">
          <h3>Datos de Compra</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="compraTotal">Total Venta *</label>
              <input type="number" id="compraTotal" [(ngModel)]="formData.compra.totalVenta" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="compraAbono">Abono</label>
              <input type="number" id="compraAbono" [(ngModel)]="formData.compra.abono" placeholder="0" />
            </div>
            <div class="form-group">
              <label for="compraSaldo">Saldo</label>
              <input type="number" id="compraSaldo" [value]="calculateSaldo()" readonly class="readonly" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="compraFormaPago">Forma de Pago *</label>
              <select id="compraFormaPago" [(ngModel)]="formData.compra.formaPago">
                @for (method of paymentMethods; track method.value) {
                  <option [value]="method.value">{{ method.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="compraFechaEntrega">Fecha de Entrega</label>
              <input type="date" id="compraFechaEntrega" [(ngModel)]="formData.compra.fechaEntrega" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3>Observaciones</h3>
          <div class="form-row">
            <div class="form-group full-width">
              <textarea [(ngModel)]="formData.observaciones" rows="3" placeholder="Observaciones adicionales..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancelar</button>
        <button class="btn-primary" (click)="saveWorkOrder()" [disabled]="isLoading">
          @if (isLoading) {
            <span class="spinner"></span>
            Guardando...
          } @else {
            {{ isEditing ? 'Actualizar' : 'Crear' }}
          }
        </button>
      </div>
    </div>
  </div>
}

@if (showDetailModal && detailWorkOrder) {
  <div class="modal-overlay" role="dialog" aria-modal="true" (click)="closeDetailModal()" (keydown.escape)="closeDetailModal()">
    <div class="modal modal-large" role="document" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Orden de Trabajo #{{ detailWorkOrder.numeroOrden }}</h2>
        <button class="btn-close" (click)="closeDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body detail-view">
        <div class="detail-section">
          <h3>Informacion General</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Empresa</span>
              <span class="value">{{ getOrderNumberTypeLabel(detailWorkOrder.tipoNumeroOrden) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Tipo</span>
              <span class="value">{{ getTypeLabel(detailWorkOrder.tipoOrden) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Fecha Venta</span>
              <span class="value">{{ formatDate(detailWorkOrder.fechaVenta) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Fecha Creacion</span>
              <span class="value">{{ formatDate(detailWorkOrder.createdAt) }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h3>Cliente</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="label">Nombre</span>
              <span class="value">{{ getClientName(detailWorkOrder) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">RUT</span>
              <span class="value">{{ getClientRut(detailWorkOrder) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Telefono</span>
              <span class="value">{{ getClientPhone(detailWorkOrder) }}</span>
            </div>
          </div>
        </div>

        @if (detailWorkOrder.receta) {
          <div class="detail-section">
            <h3>Receta - Lejos</h3>
            <div class="receta-detail">
              <div class="receta-eye">
                <h4>Ojo Derecho (OD)</h4>
                <div class="receta-values">
                  <span>ESF: {{ detailWorkOrder.receta.lejos?.od?.esfera ?? '-' }}</span>
                  <span>CIL: {{ detailWorkOrder.receta.lejos?.od?.cilindro ?? '-' }}</span>
                  <span>EJE: {{ detailWorkOrder.receta.lejos?.od?.grado ?? '-' }}</span>
                </div>
              </div>
              <div class="receta-eye">
                <h4>Ojo Izquierdo (OI)</h4>
                <div class="receta-values">
                  <span>ESF: {{ detailWorkOrder.receta.lejos?.oi?.esfera ?? '-' }}</span>
                  <span>CIL: {{ detailWorkOrder.receta.lejos?.oi?.cilindro ?? '-' }}</span>
                  <span>EJE: {{ detailWorkOrder.receta.lejos?.oi?.grado ?? '-' }}</span>
                </div>
              </div>
            </div>
            @if (detailWorkOrder.receta.detallesLejos) {
              <div class="lens-details">
                <span>DP: {{ detailWorkOrder.receta.detallesLejos.dp ?? '-' }}</span>
                <span>Cristal: {{ detailWorkOrder.receta.detallesLejos.cristal ?? '-' }}</span>
                <span>Codigo: {{ detailWorkOrder.receta.detallesLejos.codigo ?? '-' }}</span>
                <span>Color: {{ detailWorkOrder.receta.detallesLejos.color ?? '-' }}</span>
                <span>Armazon: {{ detailWorkOrder.receta.detallesLejos.armazonMarca ?? '-' }}</span>
              </div>
            }
          </div>

          <div class="detail-section">
            <h3>Receta - Cerca</h3>
            <div class="receta-detail">
              <div class="receta-eye">
                <h4>Ojo Derecho (OD)</h4>
                <div class="receta-values">
                  <span>ESF: {{ detailWorkOrder.receta.cerca?.od?.esfera ?? '-' }}</span>
                  <span>CIL: {{ detailWorkOrder.receta.cerca?.od?.cilindro ?? '-' }}</span>
                  <span>EJE: {{ detailWorkOrder.receta.cerca?.od?.grado ?? '-' }}</span>
                </div>
              </div>
              <div class="receta-eye">
                <h4>Ojo Izquierdo (OI)</h4>
                <div class="receta-values">
                  <span>ESF: {{ detailWorkOrder.receta.cerca?.oi?.esfera ?? '-' }}</span>
                  <span>CIL: {{ detailWorkOrder.receta.cerca?.oi?.cilindro ?? '-' }}</span>
                  <span>EJE: {{ detailWorkOrder.receta.cerca?.oi?.grado ?? '-' }}</span>
                </div>
              </div>
            </div>
            <div class="lens-details">
              <span>ADD: {{ detailWorkOrder.receta.add ?? '-' }}</span>
              @if (detailWorkOrder.receta.detallesCerca) {
                <span>DP: {{ detailWorkOrder.receta.detallesCerca.dp ?? '-' }}</span>
                <span>Cristal: {{ detailWorkOrder.receta.detallesCerca.cristal ?? '-' }}</span>
                <span>Codigo: {{ detailWorkOrder.receta.detallesCerca.codigo ?? '-' }}</span>
                <span>Color: {{ detailWorkOrder.receta.detallesCerca.color ?? '-' }}</span>
                <span>Armazon: {{ detailWorkOrder.receta.detallesCerca.armazonMarca ?? '-' }}</span>
              }
            </div>
          </div>
        }

        <div class="detail-section">
          <h3>Datos de Compra</h3>
          <div class="detail-grid payment-grid">
            <div class="detail-item">
              <span class="label">Total Venta</span>
              <span class="value">{{ formatCurrency(detailWorkOrder.compra.totalVenta) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Abono</span>
              <span class="value">{{ formatCurrency(detailWorkOrder.compra.abono) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Saldo</span>
              <span class="value" [class.saldo-pendiente]="(detailWorkOrder.compra.saldo || 0) > 0">
                {{ formatCurrency(detailWorkOrder.compra.saldo) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Forma de Pago</span>
              <span class="value">{{ getPaymentLabel(detailWorkOrder.compra.formaPago) }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Fecha Entrega</span>
              <span class="value">{{ detailWorkOrder.compra.fechaEntrega ? formatDate(detailWorkOrder.compra.fechaEntrega) : '-' }}</span>
            </div>
          </div>
        </div>

        @if (detailWorkOrder.observaciones) {
          <div class="detail-section">
            <h3>Observaciones</h3>
            <p class="observations">{{ detailWorkOrder.observaciones }}</p>
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDetailModal()">Cerrar</button>
        @if (isAdmin) {
          <button class="btn-primary" (click)="closeDetailModal(); openEditModal(detailWorkOrder)">
            Editar
          </button>
        }
      </div>
    </div>
  </div>
}

@if (showPrescriptionFormModal) {
  <div class="modal-overlay" role="dialog" aria-modal="true" (click)="closePrescriptionFormModal()" (keydown.escape)="closePrescriptionFormModal()">
    <div class="modal modal-prescription-form" role="document" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Receta Medica - {{ prescriptionFormType === 'lejos' ? 'Lejos' : 'Cerca' }}</h3>
        <div class="modal-header-actions">
          <button type="button" class="btn-prescription" (click)="savePrescriptionFromModal()" [disabled]="savingPrescription" title="Guardar receta">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
              <polyline points="17 21 17 13 7 13 7 21"></polyline>
              <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            {{ savingPrescription ? 'Guardando...' : 'Guardar Receta ' + (prescriptionFormType === 'lejos' ? 'Lejos' : 'Cerca') }}
          </button>
          <button type="button" class="btn-prescription btn-prescription-select" (click)="showExistingPrescriptions()" title="Cargar receta existente">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Cargar Existente
          </button>
        </div>
      </div>
      <div class="modal-body">
        @if (prescriptionSaveMessage) {
          <div class="alert alert-success">{{ prescriptionSaveMessage }}</div>
        }
        @if (prescriptionSaveError) {
          <div class="alert alert-error">{{ prescriptionSaveError }}</div>
        }
        
        @if (showExistingPrescriptionsList && clientPrescriptions.length > 0) {
          <div class="prescription-list-section">
            <h4>Recetas existentes del cliente</h4>
            <div class="prescription-list">
              @for (prescription of clientPrescriptions; track prescription._id) {
                <button type="button" class="prescription-item" (click)="selectExistingPrescription(prescription)">
                  <div class="prescription-info">
                    <span class="prescription-date">{{ formatDate(prescription.createdAt) }}</span>
                    <span class="prescription-client">{{ prescription.clienteNombre }}</span>
                  </div>
                  <div class="prescription-details">
                    @if (prescription.ojoDerecho) {
                      <span class="detail-badge">OD: {{ prescription.ojoDerecho.esfera || '-' }}</span>
                    }
                    @if (prescription.ojoIzquierdo) {
                      <span class="detail-badge">OI: {{ prescription.ojoIzquierdo.esfera || '-' }}</span>
                    }
                  </div>
                </button>
              }
            </div>
            <button type="button" class="btn-outline" (click)="hideExistingPrescriptions()">Volver al formulario</button>
          </div>
        } @else {
          <div class="receta-grid">
            <div class="receta-column">
              <h4>Ojo Derecho (OD)</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Esfera</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.od.esfera" placeholder="-2.00" />
                </div>
                <div class="form-group">
                  <label>Cilindro</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.od.cilindro" placeholder="-0.50" />
                </div>
                <div class="form-group">
                  <label>Grado/Eje</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.od.grado" placeholder="180" />
                </div>
              </div>
            </div>
            <div class="receta-column">
              <h4>Ojo Izquierdo (OI)</h4>
              <div class="form-row">
                <div class="form-group">
                  <label>Esfera</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.oi.esfera" placeholder="-2.00" />
                </div>
                <div class="form-group">
                  <label>Cilindro</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.oi.cilindro" placeholder="-0.50" />
                </div>
                <div class="form-group">
                  <label>Grado/Eje</label>
                  <input type="text" [(ngModel)]="prescriptionFormData.oi.grado" placeholder="180" />
                </div>
              </div>
            </div>
          </div>
          <div class="form-row">
            @if (prescriptionFormType === 'cerca') {
              <div class="form-group">
                <label>Adicion (ADD)</label>
                <input type="text" [(ngModel)]="prescriptionFormData.add" placeholder="+2.00" />
              </div>
            }
            <div class="form-group">
              <label>DP {{ prescriptionFormType === 'lejos' ? 'Lejos' : 'Cerca' }}</label>
              <input type="text" [(ngModel)]="prescriptionFormData.dp" placeholder="63" />
            </div>
            <div class="form-group">
              <label>Cristal</label>
              <input type="text" [(ngModel)]="prescriptionFormData.cristal" placeholder="Policarbonato" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Codigo</label>
              <input type="text" [(ngModel)]="prescriptionFormData.codigo" placeholder="PC-001" />
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="text" [(ngModel)]="prescriptionFormData.color" placeholder="Transparente" />
            </div>
            <div class="form-group">
              <label>Armazon/Marca</label>
              <input type="text" [(ngModel)]="prescriptionFormData.armazonMarca" placeholder="Ray-Ban" />
            </div>
          </div>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-secondary" (click)="closePrescriptionFormModal()">Cerrar</button>
      </div>
    </div>
  </div>
}

@if (showDeleteConfirm) {
  <div class="modal-overlay" role="dialog" aria-modal="true" (click)="cancelDelete()" (keydown.escape)="cancelDelete()">
    <div class="modal modal-confirm" role="document" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
      <div class="confirm-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h3>Confirmar eliminacion</h3>
      <p>Esta seguro que desea eliminar la orden <strong>#{{ workOrderToDelete?.numeroOrden }}</strong>?</p>
      <p class="warning-text">Esta accion no se puede deshacer.</p>
      <div class="confirm-actions">
        <button class="btn-secondary" (click)="cancelDelete()">Cancelar</button>
        <button class="btn-danger" (click)="deleteWorkOrder()" [disabled]="isLoading">
          @if (isLoading) {
            <span class="spinner"></span>
          }
          Eliminar
        </button>
      </div>
    </div>
  </div>
}
